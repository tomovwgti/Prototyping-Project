<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>frequency decoder - accessible, unobtrusive slider demo</title>
    <meta http-equiv="Content-Type"         content="text/html; charset=iso-8859-1" />
    <meta name="author"                     content="frequency decoder" />
    <meta name="description"                content="An unobtrusive javascript that turns any text input or selectlist into a keyboard-accessible slider control" />
    <meta http-equiv="imagetoolbar"         content="no" />

    <link rel="stylesheet" type="text/css" media="screen, projection" href="css/slider.css" />
    <link rel="stylesheet" type="text/css" href="css/led.css">

    <script type="text/javascript" src="js/jquery-1.7.1.js"></script>
    <script type="text/javascript" src="js/slider.js"></script>

<script type="text/javascript">
//<![CDATA[

// Preloading the images used for the slider handle
var imgList = ["slider-disabled.png", "slider-disabled-1.png", "slider.png", "slider-1.png"];
var preloadImg = []
for(var i = 0, imgSrc; imgSrc = imgList[i]; i++) {
    preloadImg[i] = new Image();
    preloadImg[i].src = "image/" + imgSrc;
};

// WebSocket
var ws = new WebSocket('ws://192.168.1.3:8001/');

// Create the div used to show the dynamically generated color
function createColorBox() {
    var dl = document.getElementsByTagName('dl')[0];
    var box  = document.createElement('div');
    box.setAttribute('id','colorBox');
    var res  = document.createElement('div');
    res.setAttribute('id','hexValue');

    dl.parentNode.insertBefore(res, dl.nextSibling);
    dl.parentNode.insertBefore(box, res);
    updateColor();

    // Clean up for poor old IE
    res = box = null;
}

// Convert and rgb value to hex
function toHex(N) {
    if (N==null) return "00";
    N=parseInt(N);
    if (N==0 || isNaN(N)) return "00";
    N=Math.max(0,N); N=Math.min(N,255);
    N=Math.round(N);
    return "0123456789ABCDEF".charAt((N-N%16)/16) + "0123456789ABCDEF".charAt(N%16);
}

// Message from Server
ws.onmessage = function (event) {
    var receive_message = JSON.parse(event.data);
    console.log('receive message <-- ' + event.data);

    if (receive_message.command === 'geo') {
        var map = 'http://maps.google.co.jp/?ie=UTF8&ll=' + receive_message.lat +',' + receive_message.lon + '&z=13'
        document.location = map;
    }
    // RGB slider contorole
    else if (receive_message.command === 'light' ) {
        updateColorfromWS(receive_message.red, receive_message.green, receive_message.blue);
    }
    // append String
    else {
        $('body').append('<li>' + receive_message.message + '</li>');
    }
}

function updateColor() {
    var r = parseInt($('#slider-r').val(), 10) || 0;
    var g = parseInt($('#slider-g').val(), 10) || 0;
    var b = parseInt($('#slider-b').val(), 10) || 0;

    $('#colorBox').css("background-color","rgb("+r+ ","+g+","+b+")");
    $('#hexValue').html('#' + toHex(r) + toHex(g) + toHex(b));

    var msg = {
        'sender': 'browser',
        'command': 'light',
        'red': 0,
        'green': 0,
        'blue': 0
    }
    msg.red = r;
    msg.green = g;
    msg.blue = b;
    console.log(JSON.stringify(msg));
    ws.send(JSON.stringify(msg));
}

function updateColorfromWS(red, green, blue) {
    $('#slider-r').attr('value', red);
    $('#slider-g').attr('value', green);
    $('#slider-b').attr('value', blue);
    $('#colorBox').css("background-color","rgb(" + red + "," + green + "," + blue + ")");
    $('#hexValue').html('#' + toHex(red) + toHex(green) + toHex(blue));
}

$(function(){
    var led_state = false;
    $('#chime').click(function() {
        var msg = {
            'sender': 'browser',
            'command': 'chime'
        }
        console.log(JSON.stringify(msg));
        ws.send(JSON.stringify(msg));
    });

    $('#led').click(function() {
        led_state = !led_state;
        var msg = {
            'sender': 'browser',
            'command': 'led',
            'status': false
        }
        msg.status = led_state;
        console.log(JSON.stringify(msg));
        ws.send(JSON.stringify(msg));
    });
});

// Demo specific onload events (uses the addEvent method bundled with the slider)
fdSliderController.addEvent(window, 'load', createColorBox);

//]]>
</script>
</head>
<body>
<div id="article-wrapper">
  <form action="" method="post">
    <fieldset>
      <dl>
        <dt>
            <label for="slider-r">Red:</label>
        </dt>
        <dd>
            <input name="slider1" id="slider-r" type="text" title="Range: 0 - 255" class="fd_range_0_255 fd_classname_extraclass fd_callback_updateColor" value="0" />
        </dd>
        <dt>
            <label for="slider-g">Green:</label>
        </dt>
        <dd>
            <input name="slider2" id="slider-g" type="text" title="Range: 0 - 255" class="fd_range_0_255 fd_classname_extraclass fd_callback_updateColor" value="0" />
        </dd>
        <dt>
            <label for="slider-b">Blue:</label>
        </dt>
        <dd>
            <input name="slider3" id="slider-b" type="text" title="Range: 0 - 255" class="fd_range_0_255 fd_classname_extraclass fd_callback_updateColor" value="0" />
        </dd>
      </dl>
    </fieldset>
  </form>
</div>
<div>
    <input type="button" id="chime" value="Chime" style="width:100px">
    <input type="button" id="led" value="LED" style="width:100px">
</div>
</body>
</html>
